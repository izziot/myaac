{% if errors is not empty %}
<div class="alert alert-danger">
	{% for error in errors %}
		<span>{{ error }}</span>
	{% endfor %}
</div>
{% endif %}

<form action="{{ constant('BASE_URL') }}install/" method="post" autocomplete="off">
	<input type="hidden" name="step" id="step" value="database" />

	{# ============================================================================== #}
	{# SITE CONFIGURATION - Always first #}
	{# ============================================================================== #}
	<div class="card mb-4">
		<div class="card-header bg-secondary text-white">
			<h5 class="mb-0">{{ locale.step_config_site_title|default('Site Configuration') }}</h5>
		</div>
		<div class="card-body">
			<div class="form-group mb-2">
				<label for="vars_site_url">{{ locale.step_config_site_url }}</label>
				<input class="form-control" type="text" name="vars[site_url]" id="vars_site_url" value="{{ session['var_site_url'] }}"/>
				<small class="form-text text-muted">{{ locale.step_config_site_url_desc }}</small>
			</div>

			<div class="form-group mb-2">
				<label for="vars_date_timezone">{{ locale.step_config_timezone }}</label>
				<select class="form-control" name="vars[date_timezone]" id="vars_date_timezone">
					{% for timezone in timezones %}
					<option value="{{ timezone }}"{% if (session['var_date_timezone'] is not null and session['var_date_timezone'] == timezone) or (session['var_date_timezone'] is null and timezone == 'Europe/Warsaw') %} selected{% endif %}>{{ timezone }}</option>
					{% endfor %}
				</select>
				<small class="form-text text-muted">{{ locale.step_config_timezone_desc }}</small>
			</div>

			<div class="form-group mb-2">
				<label for="vars_client">{{ locale.step_config_client }}</label>
				<select class="form-control" name="vars[client]" id="vars_client">
					{% for id, version in clients %}
					<option value="{{ id }}"{% if session['var_client'] is not null and session['var_client'] == id %} selected{% endif %}>{{ version }}</option>
					{% endfor %}
				</select>
				<small class="form-text text-muted">{{ locale.step_config_client_desc }}</small>
			</div>

			<div class="form-group mb-2">
				<label for="vars_usage">{{ locale.step_config_usage }}</label>
				<input type="hidden" value="0" name="vars[usage]">
				<input type="checkbox" name="vars[usage]" id="vars_usage" value="1"{% if session['var_usage'] is null or session['var_usage'] == 1 %} checked{% endif %}/>
				<small class="form-text text-muted d-block">{{ locale.step_config_usage_desc }}</small>
			</div>
		</div>
	</div>

	{# ============================================================================== #}
	{# SSH KEY - Shared across all servers #}
	{# ============================================================================== #}
	<div class="card mb-4">
		<div class="card-header bg-info text-white">
			<h5 class="mb-0">{{ locale.step_config_ssh_title|default('SSH Configuration') }}</h5>
		</div>
		<div class="card-body">
			<p class="text-muted">{{ locale.step_config_ssh_desc|default('SSH key used to clone all server repositories. Configure once, use for all servers.') }}</p>
			
			<div class="form-group mb-3">
				<label for="vars_ssh_private_key">{{ locale.step_config_ssh_private_key|default('Private SSH Key (Deploy Key)') }}</label>
				<textarea class="form-control" name="vars[ssh_private_key]" id="vars_ssh_private_key" rows="4"
					placeholder="{{ locale.step_config_ssh_private_key_placeholder|default('Paste your private SSH key here. Leave empty to use MYAAC_CANARY_REPO_KEY environment variable.') }}">{{ session['var_ssh_private_key']|default('') }}</textarea>
				<small class="form-text text-muted">
					{% if show_ssh_key_env %}
						{{ locale.step_config_ssh_private_key_env|default('MYAAC_CANARY_REPO_KEY is configured in environment. Leave empty to use it.') }}
					{% else %}
						{{ locale.step_config_ssh_private_key_noenv|default('Leave empty if MYAAC_CANARY_REPO_KEY is configured as environment variable.') }}
					{% endif %}
				</small>
			</div>
		</div>
	</div>

	{# ============================================================================== #}
	{# SERVER CONFIGURATION - Multiple servers support #}
	{# ============================================================================== #}
	<div class="card mb-4">
		<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
			<h5 class="mb-0">{{ locale.step_config_server_title|default('Server Configuration') }}</h5>
			<button type="button" class="btn btn-sm btn-light" onclick="addServer()">
				+ {{ locale.step_config_add_server|default('Add Server') }}
			</button>
		</div>
		<div class="card-body">
			<p class="text-muted">{{ locale.step_config_server_desc|default('Configure one or more game servers. The first server will be used for installation.') }}</p>
			
			<div id="servers-container">
				{# Server entries will be rendered here #}
			</div>
		</div>
	</div>

	<div class="text-center m-3">
	{{ buttons|raw }}
	</div>

</form>

{# ============================================================================== #}
{# JavaScript for dynamic server management #}
{# ============================================================================== #}
<script>
let serverCount = 0;
const defaultServers = {{ servers|json_encode|raw }};

function createServerFields(index, serverData) {
	const isFirst = index === 0;
	const serverName = serverData?.name || (index === 0 ? 'sovereign' : '');
	const gitRepo = serverData?.git_repo || 'git@github.com:izziot/canary.git';
	const gitBranch = serverData?.git_branch || (index === 0 ? 'test/sovereign' : 'main');
	const configPath = serverData?.config_path || 'config/config.lua';
	const dataPath = serverData?.data_path || 'data/';
	
	const html = `
		<div class="server-entry card mb-3" id="server-${index}">
			<div class="card-header ${isFirst ? 'bg-success' : 'bg-light'} text-${isFirst ? 'white' : 'dark'} d-flex justify-content-between align-items-center">
				<strong>${isFirst ? '★ ' : ''}${locale.step_config_server|default('Server')} #${index + 1}${isFirst ? ' (Primary - used for installation)' : ''}</strong>
				${!isFirst ? '<button type="button" class="btn btn-sm btn-danger" onclick="removeServer(' + index + ')">× Remove</button>' : ''}
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-6">
						<div class="form-group mb-3">
							<label>${locale.step_config_server_name|default('Server Name')} *</label>
							<input type="text" class="form-control" name="vars[servers][${index}][name]" 
								value="${serverName}" required placeholder="ex: Sovereign, World2"/>
						</div>
					</div>
					<div class="col-md-6">
						<div class="form-group mb-3">
							<label>${locale.step_config_git_repo|default('Git Repository URL')} *</label>
							<input type="text" class="form-control" name="vars[servers][${index}][git_repo]" 
								value="${gitRepo}" required placeholder="git@github.com:user/repo.git"/>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-6">
						<div class="form-group mb-3">
							<label>${locale.step_config_git_branch|default('Git Branch')} *</label>
							<input type="text" class="form-control" name="vars[servers][${index}][git_branch]" 
								value="${gitBranch}" required placeholder="ex: test/sovereign, main"/>
						</div>
					</div>
					<div class="col-md-3">
						<div class="form-group mb-3">
							<label>${locale.step_config_config_path|default('Config Path')}</label>
							<input type="text" class="form-control" name="vars[servers][${index}][config_path]" 
								value="${configPath}" placeholder="config/config.lua"/>
						</div>
					</div>
					<div class="col-md-3">
						<div class="form-group mb-3">
							<label>${locale.step_config_data_path|default('Data Path')}</label>
							<input type="text" class="form-control" name="vars[servers][${index}][data_path]" 
								value="${dataPath}" placeholder="data/"/>
						</div>
					</div>
				</div>
			</div>
		</div>
	`;
	return html;
}

function addServer() {
	const container = document.getElementById('servers-container');
	container.insertAdjacentHTML('beforeend', createServerFields(serverCount, null));
	serverCount++;
}

function removeServer(index) {
	const serverDiv = document.getElementById('server-' + index);
	if (serverDiv) {
		serverDiv.remove();
	}
}

function initServers() {
	const container = document.getElementById('servers-container');
	
	// If we have servers in session, render them
	{% if session['var_servers'] is defined and session['var_servers'] is not empty %}
		const savedServers = {{ session['var_servers']|json_encode|raw }};
		if (savedServers && savedServers.length > 0) {
			savedServers.forEach((server, index) => {
				container.insertAdjacentHTML('beforeend', createServerFields(index, server));
			});
			serverCount = savedServers.length;
		} else {
			// No servers saved, add first one
			container.insertAdjacentHTML('beforeend', createServerFields(0, null));
			serverCount = 1;
		}
	{% else %}
		// Default: add first server
		container.insertAdjacentHTML('beforeend', createServerFields(0, null));
		serverCount = 1;
	{% endif %}
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initServers);
</script>
