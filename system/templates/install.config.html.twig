{% if errors is not empty %}
<div class="alert alert-danger">
	{% for error in errors %}
		<span>{{ error }}</span>
	{% endfor %}
</div>
{% endif %}

<form action="{{ constant('BASE_URL') }}install/" method="post" autocomplete="off">
	<input type="hidden" name="step" id="step" value="database" />

	{# ============================================================================== #}
	{# SITE CONFIGURATION - Always first #}
	{# ============================================================================== #}
	<div class="card mb-4">
		<div class="card-header bg-secondary text-white">
			<h5 class="mb-0">{{ locale.step_config_site_title|default('Site Configuration') }}</h5>
		</div>
		<div class="card-body">
			<div class="form-group mb-2">
				<label for="vars_site_url">{{ locale.step_config_site_url }}</label>
				<input class="form-control" type="text" name="vars[site_url]" id="vars_site_url" value="{{ session['var_site_url'] }}"/>
				<small class="form-text text-muted">{{ locale.step_config_site_url_desc }}</small>
			</div>

			<div class="form-group mb-2">
				<label for="vars_date_timezone">{{ locale.step_config_timezone }}</label>
				<select class="form-control" name="vars[date_timezone]" id="vars_date_timezone">
					{% for timezone in timezones %}
					<option value="{{ timezone }}"{% if (session['var_date_timezone'] is not null and session['var_date_timezone'] == timezone) or (session['var_date_timezone'] is null and timezone == 'Europe/Warsaw') %} selected{% endif %}>{{ timezone }}</option>
					{% endfor %}
				</select>
				<small class="form-text text-muted">{{ locale.step_config_timezone_desc }}</small>
			</div>

			<div class="form-group mb-2">
				<label for="vars_client">{{ locale.step_config_client }}</label>
				<select class="form-control" name="vars[client]" id="vars_client">
					{% for id, version in clients %}
					<option value="{{ id }}"{% if session['var_client'] is not null and session['var_client'] == id %} selected{% endif %}>{{ version }}</option>
					{% endfor %}
				</select>
				<small class="form-text text-muted">{{ locale.step_config_client_desc }}</small>
			</div>

			<div class="form-group mb-2">
				<label for="vars_usage">{{ locale.step_config_usage }}</label>
				<input type="hidden" value="0" name="vars[usage]">
				<input type="checkbox" name="vars[usage]" id="vars_usage" value="1"{% if session['var_usage'] is null or session['var_usage'] == 1 %} checked{% endif %}/>
				<small class="form-text text-muted d-block">{{ locale.step_config_usage_desc }}</small>
			</div>
		</div>
	</div>

	{# ============================================================================== #}
	{# SSH KEY - Shared across all servers #}
	{# ============================================================================== #}
	<div class="card mb-4">
		<div class="card-header bg-info text-white">
			<h5 class="mb-0">{{ locale.step_config_ssh_title|default('SSH Configuration') }}</h5>
		</div>
		<div class="card-body">
			<p class="text-muted">{{ locale.step_config_ssh_desc|default('SSH key used to clone all server repositories. Configure once, use for all servers.') }}</p>
			
			<div class="form-group mb-3">
				<label for="vars_ssh_private_key">{{ locale.step_config_ssh_private_key|default('Private SSH Key (Deploy Key)') }}</label>
				<textarea class="form-control" name="vars[ssh_private_key]" id="vars_ssh_private_key" rows="4"
					placeholder="{{ locale.step_config_ssh_private_key_placeholder|default('Paste your private SSH key here. Leave empty to use MYAAC_CANARY_REPO_KEY environment variable.') }}">{{ session['var_ssh_private_key']|default('') }}</textarea>
				<small class="form-text text-muted">
					{% if show_ssh_key_env %}
						{{ locale.step_config_ssh_private_key_env|default('MYAAC_CANARY_REPO_KEY is configured in environment. Leave empty to use it.') }}
					{% else %}
						{{ locale.step_config_ssh_private_key_noenv|default('Leave empty if MYAAC_CANARY_REPO_KEY is configured as environment variable.') }}
					{% endif %}
				</small>
			</div>
		</div>
	</div>

	{# ============================================================================== #}
	{# SERVER CONFIGURATION - Multiple servers support #}
	{# ============================================================================== #}
	<div class="card mb-4">
		<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
			<h5 class="mb-0">{{ locale.step_config_server_title|default('Server Configuration') }}</h5>
			<button type="button" class="btn btn-sm btn-light" onclick="addServer()">
				+ {{ locale.step_config_add_server|default('Add Server') }}
			</button>
		</div>
		<div class="card-body">
			<p class="text-muted">{{ locale.step_config_server_desc|default('Configure one or more game servers. The first server will be used for installation.') }}</p>
			
			<div id="servers-container">
				{# Server entries will be rendered here #}
			</div>
		</div>
	</div>

	<div class="text-center m-3">
	{{ buttons|raw }}
	</div>

</form>

{# ============================================================================== #}
{# JavaScript for dynamic server management #}
{# ============================================================================== #}
<script>
(function() {
'use strict';

var serverCount = 0;

function createServerFields(index, serverData) {
    var isFirst = (index === 0);
    var serverName = (serverData && serverData.name) ? serverData.name : '';
    var gitRepo = (serverData && serverData.git_repo) ? serverData.git_repo : 'git@github.com:izziot/canary.git';
    var gitBranch = (serverData && serverData.git_branch) ? serverData.git_branch : 'main';
    var configPath = (serverData && serverData.config_path) ? serverData.config_path : 'config/config.lua';
    var dataPath = (serverData && serverData.data_path) ? serverData.data_path : 'data/';
    
    if (index === 0 && !serverName) {
        serverName = 'sovereign';
    }
    if (index === 0 && !gitBranch) {
        gitBranch = 'test/sovereign';
    }
    
    var html = '<div class="server-entry card mb-3" id="server-' + index + '">';
    html += '<div class="card-header ' + (isFirst ? 'bg-success' : 'bg-light') + ' text-' + (isFirst ? 'white' : 'dark') + ' d-flex justify-content-between align-items-center">';
    html += '<strong>' + (isFirst ? '★ ' : '') + 'Server #' + (index + 1) + (isFirst ? ' (Primary - used for installation)' : '') + '</strong>';
    if (!isFirst) {
        html += '<button type="button" class="btn btn-sm btn-danger" onclick="removeServer(' + index + ')">× Remove</button>';
    }
    html += '</div>';
    html += '<div class="card-body">';
    html += '<div class="row">';
    html += '<div class="col-md-6">';
    html += '<div class="form-group mb-3">';
    html += '<label>Server Name *</label>';
    html += '<input type="text" class="form-control" name="vars[servers][' + index + '][name]" value="' + serverName + '" required placeholder="ex: Sovereign, World2"/>';
    html += '</div>';
    html += '</div>';
    html += '<div class="col-md-6">';
    html += '<div class="form-group mb-3">';
    html += '<label>Git Repository URL *</label>';
    html += '<input type="text" class="form-control" name="vars[servers][' + index + '][git_repo]" value="' + gitRepo + '" required placeholder="git@github.com:user/repo.git"/>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '<div class="row">';
    html += '<div class="col-md-6">';
    html += '<div class="form-group mb-3">';
    html += '<label>Git Branch *</label>';
    html += '<input type="text" class="form-control" name="vars[servers][' + index + '][git_branch]" value="' + gitBranch + '" required placeholder="ex: test/sovereign, main"/>';
    html += '</div>';
    html += '</div>';
    html += '<div class="col-md-3">';
    html += '<div class="form-group mb-3">';
    html += '<label>Config Path</label>';
    html += '<input type="text" class="form-control" name="vars[servers][' + index + '][config_path]" value="' + configPath + '" placeholder="config/config.lua"/>';
    html += '</div>';
    html += '</div>';
    html += '<div class="col-md-3">';
    html += '<div class="form-group mb-3">';
    html += '<label>Data Path</label>';
    html += '<input type="text" class="form-control" name="vars[servers][' + index + '][data_path]" value="' + dataPath + '" placeholder="data/"/>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    return html;
}

window.addServer = function() {
    var container = document.getElementById('servers-container');
    if (container) {
        container.insertAdjacentHTML('beforeend', createServerFields(serverCount, null));
        serverCount++;
    } else {
        console.error('servers-container not found');
    }
};

window.removeServer = function(index) {
    var serverDiv = document.getElementById('server-' + index);
    if (serverDiv) {
        serverDiv.remove();
    }
};

function initServers() {
    var container = document.getElementById('servers-container');
    if (!container) {
        console.error('servers-container not found');
        return;
    }
    
    try {
        var savedServers = null;
        {% if session['var_servers'] is defined and session['var_servers'] is not empty %}
        savedServers = {{ session['var_servers']|json_encode|raw }};
        {% endif %}
        
        if (savedServers && savedServers.length > 0) {
            for (var i = 0; i < savedServers.length; i++) {
                container.insertAdjacentHTML('beforeend', createServerFields(i, savedServers[i]));
            }
            serverCount = savedServers.length;
        } else {
            container.insertAdjacentHTML('beforeend', createServerFields(0, null));
            serverCount = 1;
        }
    } catch (e) {
        console.error('Error initializing servers:', e);
        container.insertAdjacentHTML('beforeend', createServerFields(0, null));
        serverCount = 1;
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initServers);
} else {
    initServers();
}

})();
</script>
